<html><head>
<style>
#info {
  position: absolute;
  top: 2%;
  width: 100%;
  padding: 10px;
  text-align: center;
  color: #ffff00
}

#speedShow {
    color: white;
}

body {
  overflow: hidden;
}
</style>
</head>

<body> 
<div id="info">HW2<br/>
   <button id="viewpoint" style="width:15%">third</button>
   <button id="walk" style="width:15%">dance</button>
   <div id="intro">press left/right to control speed </div>
   <div id="speedShow"></div>
</div>
<audio id="audio" src="http://homepage.ttu.edu.tw/u10206217/6sec.mp3"></audio>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r70/three.min.js"></script>
<script src="https://dl.dropboxusercontent.com/u/3587259/Code/Threejs/OrbitControls.js"></script>
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="https://jyunming-chen.github.io/tutsplus/js/KeyboardState.js"></script>

<script>
var scene, renderer, camera;
var controls;
var leftLeg, rightLeg, body, head, move;
var frontSkirt, backSkirt, leftSkirt, rightSkirt;
var viewpoint = true, walk = true;
var clock = new THREE.Clock();
var clock2 = new THREE.Clock();
var keyboard = new KeyboardState();
var period = 6.1;
var v = 100;
var pose0 = {
	headAngle1:0, headAngle2:0, headAngle3:0,
  bodyAngle1:0, bodyAngle2:0, bodyAngle3:0,
  leftArmAngle1:0, leftArmAngle2:0, leftArmAngle3:0,
  rightArmAngle1:0, rightArmAngle2:0, rightArmAngle3:0,
  leftLegAngle1:0,leftLegAngle2:0, leftLegAngle3:0,
  rightLegAngle1:0, rightLegAngle2:0,rightLegAngle3:0
};
var pose1 = {
	headAngle1:0, headAngle2:0, headAngle3:0,
  bodyAngle1:0.051438, bodyAngle2:0, bodyAngle3:0,
  leftArmAngle1:-1.596457, leftArmAngle2:0, leftArmAngle3:0,
  rightArmAngle1:-0.810769, rightArmAngle2:0, rightArmAngle3:0,
  leftLegAngle1:-0.097965,leftLegAngle2:0, leftLegAngle3:0,
  rightLegAngle1:-0.097965, rightLegAngle2:0,rightLegAngle3:0
}
var pose2 = {
	headAngle1:0, headAngle2:0, headAngle3:0,
  bodyAngle1:0.051438, bodyAngle2:0, bodyAngle3:0,
  leftArmAngle1:-0.810769, leftArmAngle2:0, leftArmAngle3:0,
  rightArmAngle1:-1.596457, rightArmAngle2:0, rightArmAngle3:0,
  leftLegAngle1:-0.097965,leftLegAngle2:0, leftLegAngle3:0,
  rightLegAngle1:-0.097965, rightLegAngle2:0,rightLegAngle3:0
}
var pose3 = {
	headAngle1:0.415388, headAngle2:-0.213251, headAngle3:-0.180889,
  bodyAngle1:0.205841, bodyAngle2:0, bodyAngle3:0,
  leftArmAngle1:0, leftArmAngle2:0, leftArmAngle3:0,
  rightArmAngle1:0, rightArmAngle2:0, rightArmAngle3:-1.585760,
  leftLegAngle1:-0.198982,leftLegAngle2:0, leftLegAngle3:0,
  rightLegAngle1:-0.198982, rightLegAngle2:0,rightLegAngle3:0
}
var pose4 = {
	headAngle1:0.415388, headAngle2:0.213251, headAngle3:0.180889,
  bodyAngle1:0.205841, bodyAngle2:0, bodyAngle3:0,
  leftArmAngle1:0, leftArmAngle2:0, leftArmAngle3:1.585760,
  rightArmAngle1:0, rightArmAngle2:0, rightArmAngle3:0,
  leftLegAngle1:-0.198982,leftLegAngle2:0, leftLegAngle3:0,
  rightLegAngle1:-0.198982, rightLegAngle2:0,rightLegAngle3:0
}
var pose5 = {
	headAngle1:-0.290453, headAngle2:0, headAngle3:0,
  bodyAngle1:-0.036791, bodyAngle2:-0.400741, bodyAngle3:-0.025762,
  leftArmAngle1:0.357066, leftArmAngle2:0, leftArmAngle3:0.3,
  rightArmAngle1:-1.943879, rightArmAngle2:0, rightArmAngle3:-0.3,
  leftLegAngle1:-0.3,leftLegAngle2:0, leftLegAngle3:0,
  rightLegAngle1:0.3, rightLegAngle2:0,rightLegAngle3:0
}
var pose6 = {
	headAngle1:-0.290453, headAngle2:0, headAngle3:0,
  bodyAngle1:-0.036791, bodyAngle2:0.400741, bodyAngle3:-0.025762,
  leftArmAngle1:-1.943879, leftArmAngle2:0, leftArmAngle3:0.3,
  rightArmAngle1:0.357066, rightArmAngle2:0, rightArmAngle3:-0.3,
  leftLegAngle1:0.3,leftLegAngle2:0, leftLegAngle3:0,
  rightLegAngle1:-0.3, rightLegAngle2:0,rightLegAngle3:0
}
var pose7 = {
	headAngle1:0, headAngle2:0, headAngle3:0,
  bodyAngle1:0.426417, bodyAngle2:0, bodyAngle3:0,
  leftArmAngle1:0.469307, leftArmAngle2:0, leftArmAngle3:0.3,
  rightArmAngle1:0.469307, rightArmAngle2:0, rightArmAngle3:-0.3,
  leftLegAngle1:-0.416345,leftLegAngle2:0, leftLegAngle3:0,
  rightLegAngle1:-0.416345, rightLegAngle2:0,rightLegAngle3:0
}
var pose8 = {
	headAngle1:-0.246338, headAngle2:0, headAngle3:0,
  bodyAngle1:-0.279424, bodyAngle2:0, bodyAngle3:0,
  leftArmAngle1:-2, leftArmAngle2:0, leftArmAngle3:0.3,
  rightArmAngle1:-2, rightArmAngle2:0, rightArmAngle3:-0.3,
  leftLegAngle1:0.212205,leftLegAngle2:0, leftLegAngle3:0,
  rightLegAngle1:0.212205, rightLegAngle2:0,rightLegAngle3:0
}

var keys = [{s: 0,pose: pose0}, {s: 0.058,pose: pose1}, {s: 0.117,pose: pose2}, {s: 0.176,pose: pose1}, {s: 0.234,pose: pose2}, {s: 0.294,pose: pose3}, {s: 0.352,pose: pose4}, {s: 0.411,pose: pose3}, {s: 0.470,pose: pose4}, {s: 0.529,pose: pose5}, {s: 0.588,pose: pose6}, {s: 0.647,pose: pose5}, {s: 0.705,pose: pose6}, {s: 0.764,pose: pose7}, {s: 0.823,pose: pose8}, {s: 0.882,pose: pose7}, {s: 0.941,pose: pose8}, {s: 1,pose: pose0}];

$('#viewpoint').click(function() {
  if(viewpoint) {
  	viewpoint = false;
    $(this).text("god");
  } else {
    viewpoint = true;
    $(this).text("third");
  }
});

$('#walk').click(function() {
  if(walk) {
  	walk = false;
    $(this).text("walk");
    audio.muted = false;
  	audio.currentTime = 0;
    clock2.start();
  } else {
    walk = true;
    $(this).text("dance");
    audio.muted = true;
    clock2 = new THREE.Clock();
    clock2.stop();
  }
});

init();
animate();

function init() {
  scene = new THREE.Scene();
  renderer = new THREE.WebGLRenderer();
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setClearColor(0x888888);
  document.body.appendChild(renderer.domElement);
	
  var gridXZ = new THREE.GridHelper(300, 20);
  gridXZ.setColors(new THREE.Color(0xff0000), new THREE.Color(0xffffff));
  gridXZ.position.y = -33;
  scene.add(gridXZ);
  
  camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 1000);
  camera.position.set(0, 150, 600);
  controls = new THREE.OrbitControls(camera, renderer.domElement);
	
  //light
	var light = new THREE.PointLight(0xffffff, 1);
  light.position.set(100, 500, 700);
  scene.add(light);
  var light2 = new THREE.PointLight(0xffffff, 1);
  light2.position.set(100, 500, -700);
  scene.add(light2);
  	
  THREE.ImageUtils.crossOrigin = '';
  texture = THREE.ImageUtils.loadTexture('http://i.imgur.com/JWnJnZ8.jpg');
  var headMaterialArray = [];
  headMaterialArray.push(new THREE.MeshLambertMaterial({
    map: THREE.ImageUtils.loadTexture('http://i.imgur.com/r5VHA5C.jpg'), side:THREE.DoubleSide}));
  headMaterialArray.push(new THREE.MeshLambertMaterial({
    map: THREE.ImageUtils.loadTexture('http://i.imgur.com/u2mdVuf.jpg'), side:THREE.DoubleSide}));
  headMaterialArray.push(new THREE.MeshLambertMaterial({
    map: THREE.ImageUtils.loadTexture('http://i.imgur.com/FxfinQG.jpg'), side:THREE.DoubleSide}));
  headMaterialArray.push(new THREE.MeshLambertMaterial({visible: false}));
  headMaterialArray.push(new THREE.MeshLambertMaterial({
    map: THREE.ImageUtils.loadTexture('http://i.imgur.com/wZCPkNO.png'), side:THREE.DoubleSide}));
  headMaterialArray.push(new THREE.MeshLambertMaterial({
    map: THREE.ImageUtils.loadTexture('http://i.imgur.com/cKwkXx9.jpg'), side:THREE.DoubleSide}));
  
  var bodyMaterialArray = [];
  bodyMaterialArray.push(new THREE.MeshLambertMaterial({map: texture, side:THREE.DoubleSide}));
  bodyMaterialArray.push(new THREE.MeshLambertMaterial({map: texture, side:THREE.DoubleSide}));
  bodyMaterialArray.push(new THREE.MeshLambertMaterial({map: texture, side:THREE.DoubleSide}));
  bodyMaterialArray.push(new THREE.MeshLambertMaterial({visible: false}));
  bodyMaterialArray.push(new THREE.MeshLambertMaterial({
    map: THREE.ImageUtils.loadTexture('http://i.imgur.com/vqgckgB.jpg'), side:THREE.DoubleSide}));
  bodyMaterialArray.push(new THREE.MeshLambertMaterial({
    map: THREE.ImageUtils.loadTexture('http://i.imgur.com/L0lw4Wg.jpg'), side:THREE.DoubleSide}));

  //leg and joint
  leftLeg = new THREE.Object3D();
  rightLeg = new THREE.Object3D();
  var material = new THREE.MeshLambertMaterial({map: texture});
	var mesh = new THREE.Mesh(new THREE.BoxGeometry(10, 27, 19), material);
  leftLeg.position.set(10, 0, 0);
  
  rightLeg.position.set(-10, 0, 0);
  mesh.position.set(0, -20, 0);
  
  var mesh2 = mesh.clone();
  mesh2.position.set(00, -20, 0);
  var joint = new THREE.Mesh (new THREE.CylinderGeometry (4, 4, 10, 16),
  	new THREE.MeshBasicMaterial({wireframe:true}));
  joint.rotation.x = Math.PI/2;
  joint.position.y = 18;
  mesh.add (joint);
  var joint2 = joint.clone();
  mesh2.add (joint2);
  rightLeg.add(mesh);
  leftLeg.add(mesh2);
  scene.add(rightLeg);
  scene.add(leftLeg);
  
  //skirt
  frontSkirt = new THREE.Object3D();
  backSkirt = new THREE.Object3D();
  leftSkirt = new THREE.Object3D();
  rightSkirt = new THREE.Object3D();
  //front
  mesh = new THREE.Mesh (new THREE.PlaneGeometry(32, 12), new THREE.MeshLambertMaterial ({map: texture, side:THREE.DoubleSide}));
  mesh.position.y = -6;
  frontSkirt.add (mesh);
  scene.add(frontSkirt);
  frontSkirt.position.set(0, 0.5, 11);
  frontSkirt.rotation.x = Math.PI/6*(-1);
  //back
  mesh2 = mesh.clone();
  mesh2.position.y = -6;
  backSkirt.add (mesh2);
  scene.add(backSkirt);
  backSkirt.position.set(0, 0.5, -11);
  backSkirt.rotation.x = Math.PI/6;
  //left
  mesh = new THREE.Mesh (new THREE.PlaneGeometry(22, 12), new THREE.MeshLambertMaterial ({map: texture, side:THREE.DoubleSide}));
  mesh.position.y = -6;
  mesh.rotation.y = Math.PI/2;
  leftSkirt.add(mesh);
  scene.add(leftSkirt);
  leftSkirt.position.set(16, 0.5, 0);
  leftSkirt.rotation.z = Math.PI/6;
  //right
  mesh2 = mesh.clone();
  mesh2.position.y = -6;
  mesh2.rotation.y = Math.PI/2*(-1);
  rightSkirt.add(mesh2);
  scene.add(rightSkirt);
  rightSkirt.position.set(-16, 0.5, 0);
  rightSkirt.rotation.z = Math.PI/6*(-1);
  
  //arm
  leftArm = new THREE.Object3D();
  rightArm = new THREE.Object3D();
  //left
  mesh = new THREE.Mesh (new THREE.BoxGeometry (10, 33, 12), material);
  leftArm.position.set (20, 35, 0);
  mesh.position.set(0, -20, 0);
  leftArm.rotation.z = 0.3;
  joint = new THREE.Mesh (new THREE.CylinderGeometry (4, 4, 10, 16),
  	new THREE.MeshBasicMaterial({wireframe:true}));
  joint.rotation.x = Math.PI/2;
  joint.position.y = 20.5;
  mesh.add (joint);
  leftArm.add(mesh);
  scene.add(leftArm);
  //right
  mesh2 = mesh.clone();
  rightArm.position.set (-20, 35, 0);
  mesh2.position.set(0, -20, 0);
  rightArm.rotation.z = -0.3;
  joint2 = joint.clone();
  joint2.rotation.x = Math.PI/2;
  joint.position.y = 20.5;
  mesh2.add (joint2);
  rightArm.add(mesh2);
  scene.add(rightArm);

	//head
  head = new THREE.Object3D();
  mesh = new THREE.Mesh(new THREE.BoxGeometry(52, 33.6, 36), new THREE.MeshFaceMaterial(headMaterialArray));
  head.position.set(0, 39.7, 0);
  mesh.position.set(0, 16.8, 0);
  head.add(mesh);
  scene.add(head);
  
  //body
  body = new THREE.Object3D();
  mesh = new THREE.Mesh(new THREE.BoxGeometry(32, 39, 22), new THREE.MeshFaceMaterial(bodyMaterialArray));
  mesh.position.y = 20;
  body.add(mesh);
  body.add(head);
  body.add(leftArm);
  body.add(rightArm);
  body.add(leftLeg);
  body.add(rightLeg);
  body.add(frontSkirt);
  body.add(backSkirt);
  body.add(leftSkirt);
  body.add(rightSkirt);
  scene.add(body);


	clock2.stop();



  window.addEventListener('resize', onWindowResize, false);
}

function onWindowResize() {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}

function animate() {
	controls.update();
  keyboard.update();
  
  if (keyboard.down ("left"))
  	v-=10;
  else if (keyboard.down ("right"))
  	v+=10;
  
  document.getElementById("speedShow").innerHTML = v;
  this.do = (this.do === undefined) ? 0 : this.do;
  if(viewpoint) {
  	if(!(this.do)) {
  		camera.position.set(0, 150, 600);
    	this.do = 1;
    }
  } else {
    camera.position.copy(body.localToWorld(new THREE.Vector3(0, 120, -160)));
    camera.lookAt(body.localToWorld(new THREE.Vector3(0, 0, 0)));
    this.do = 0;
  }
  
  if (walk) {
  	audio.muted = true;
    head.rotation.set(0, 0, 0);
    body.rotation.set(0, 0, 0);
    leftArm.rotation.set(0, 0, 0);
    rightArm.rotation.set(0, 0, 0);
    leftLeg.rotation.set(0, 0, 0);
    rightLeg.rotation.set(0, 0, 0);
    this.angle = (this.angle === undefined) ? 0 : this.angle;
    this.armAngle = (this.armAngle === undefined) ? 0 : this.armAngle;
  	this.sign = (this.sign === undefined) ? (-1) : this.sign;
    
    this.angle += v/(2*Math.PI*150) * 2 * Math.PI * clock.getDelta();
    if (this.angle >= 2*Math.PI) {
    	this.angle = 0;
    }
    body.position.set(150*Math.cos(angle),0,150*Math.sin(angle));
    body.rotation.y=-angle;

		if (this.armAngle < Math.PI/6*(-1) || this.armAngle > Math.PI/6)
  		this.sign *= -1;
    this.armAngle += this.sign*v/(2*Math.PI*150)/2;
 
    leftLeg.rotation.x = this.armAngle;
  	rightLeg.rotation.x = this.armAngle*(-1);
  	leftArm.rotation.x = this.armAngle*(-1);
  	rightArm.rotation.x = this.armAngle;
    
  } else {
  	audio.play();
  	body.position.set(0, 0, 0);
    leftLeg.rotation.x = rightLeg.rotation.x = 0;
  	leftArm.rotation.x = rightArm.rotation.x = 0;
    
    var t = clock2.getElapsedTime() % period;
  	var s = t / period;
  	for (var i = keys.length - 1; i >= 0; i--) {
    	if (s > keys[i].s)
    		break;
  	}
    var tt = (s - keys[i].s) / (keys[i + 1].s - keys[i].s);
    var angle3 = (1 - tt) * keys[i].pose.headAngle1 + tt * keys[i + 1].pose.headAngle1;
    head.rotation.x = angle3;
    angle3 = (1 - tt) * keys[i].pose.headAngle2 + tt * keys[i + 1].pose.headAngle2;
    head.rotation.y = angle3;
    angle3 = (1 - tt) * keys[i].pose.headAngle3 + tt * keys[i + 1].pose.headAngle3;
    head.rotation.z = angle3;
    angle3 = (1 - tt) * keys[i].pose.bodyAngle1 + tt * keys[i + 1].pose.bodyAngle1;
    body.rotation.x = angle3;
    angle3 = (1 - tt) * keys[i].pose.bodyAngle2 + tt * keys[i + 1].pose.bodyAngle2;
    body.rotation.y = angle3;
    angle3 = (1 - tt) * keys[i].pose.bodyAngle3 + tt * keys[i + 1].pose.bodyAngle3;
    body.rotation.z = angle3;
    angle3 = (1 - tt) * keys[i].pose.leftArmAngle1 + tt * keys[i + 1].pose.leftArmAngle1;
    leftArm.rotation.x = angle3;
    angle3 = (1 - tt) * keys[i].pose.leftArmAngle2 + tt * keys[i + 1].pose.leftArmAngle2;
    leftArm.rotation.y = angle3;
    angle3 = (1 - tt) * keys[i].pose.leftArmAngle3 + tt * keys[i + 1].pose.leftArmAngle3;
    leftArm.rotation.z = angle3;
    angle3 = (1 - tt) * keys[i].pose.rightArmAngle1 + tt * keys[i + 1].pose.rightArmAngle1;
    rightArm.rotation.x = angle3;
    angle3 = (1 - tt) * keys[i].pose.rightArmAngle2 + tt * keys[i + 1].pose.rightArmAngle2;
    rightArm.rotation.y = angle3;
    angle3 = (1 - tt) * keys[i].pose.rightArmAngle3 + tt * keys[i + 1].pose.rightArmAngle3;
    rightArm.rotation.z = angle3;
    angle3 = (1 - tt) * keys[i].pose.leftLegAngle1 + tt * keys[i + 1].pose.leftLegAngle1;
    leftLeg.rotation.x = angle3;
    angle3 = (1 - tt) * keys[i].pose.leftLegAngle2 + tt * keys[i + 1].pose.leftLegAngle2;
    leftLeg.rotation.y = angle3;
    angle3 = (1 - tt) * keys[i].pose.leftLegAngle3 + tt * keys[i + 1].pose.leftLegAngle3;
    leftLeg.rotation.z = angle3;
    angle3 = (1 - tt) * keys[i].pose.rightLegAngle1 + tt * keys[i + 1].pose.rightLegAngle1;
    rightLeg.rotation.x = angle3;
    angle3 = (1 - tt) * keys[i].pose.rightLegAngle2 + tt * keys[i + 1].pose.rightLegAngle2;
    rightLeg.rotation.y = angle3;
    angle3 = (1 - tt) * keys[i].pose.rightLegAngle3 + tt * keys[i + 1].pose.rightLegAngle3;
    rightLeg.rotation.z = angle3;
  }
  
  
  requestAnimationFrame(animate);
  renderer.render(scene, camera);
}

</script>

</body>

</html>
