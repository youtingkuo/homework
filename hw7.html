<html><head>
<style>
#info {
  position: absolute;
  top: 2%;
  width: 100%;
  padding: 10px;
  text-align: center;
  color: #ffff00
}

body {
  background-color: #fff;
  color: #111;
  margin: 0px;
  overflow: hidden;
  font-family: Monospace;
  font-size: 10px;
  position: absolute;
}
</style>
</head>
<body> 
<div id="info">HW7</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r76/three.min.js"></script>
<script src="https://dl.dropboxusercontent.com/u/3587259/Code/Threejs/OrbitControls.js">
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.5.1/dat.gui.min.js"></script>

<script id="myVertexShader" type="x-shader/x-vertex">
	varying vec2 vUv;
	void main() {
		gl_Position = projectionMatrix* modelViewMatrix * vec4( position, 1.0);
		vUv = uv;
	}
</script>
<script id="myFragmentShader" type="x-shader/x-fragment">
	uniform sampler2D texture;
	varying vec2 vUv;
  uniform float fade;
vec3 rgb2hsv(vec3 c)
{
    vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
    vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));
    vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));

    float d = q.x - min(q.w, q.y);
    float e = 1.0e-10;
    return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);
}

vec3 hsv2rgb(vec3 c)
{
    vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
    vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
    return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
}	
	void main() {
		vec4 color = texture2D (texture, vUv);
    vec3 hsv = rgb2hsv (color.rgb);
    hsv.y /= pow(2.,fade);
    vec3 rgb = hsv2rgb (hsv.xyz);
	gl_FragColor = vec4 (rgb, 1.0);
	}
</script>
<script>
var scene, renderer, camera;
var controls;
var pointLight;
var sceneRTT, sceneColor, sceneMono, rtTexture;
var torus1, torus2, torus3;
var blocker1, blocker2, blocker3;
var rttmaterial, quad;
var camera2;
var angle = 0.02;
init();
animate();

function init() {
	rtTexture = new THREE.WebGLRenderTarget( 
		1024,1024,
		{ minFilter: THREE.LinearFilter, magFilter: THREE.NearestFilter, format: THREE.RGBFormat } 
		);

	renderer = new THREE.WebGLRenderer({antialias: true});
	renderer.setSize (window.innerWidth, window.innerHeight);
	document.body.appendChild (renderer.domElement);
	renderer.setClearColor (0x296C20);
	renderer.autoClear = false;
  
  camera = new THREE.PerspectiveCamera (45, window.innerWidth/window.innerHeight, 0.1, 10000);
  camera.position.set(200, 50, 300);
	camera.lookAt (new THREE.Vector3(0,0,0));
  
  camera2 = new THREE.OrthographicCamera (-150,150,150,-150, -10000,10000);
  
	controls = new THREE.OrbitControls (camera, renderer.domElement);
  
  sceneRTT = new THREE.Scene();	
	pointLight = new THREE.PointLight (0xffffff);
	pointLight.position.set (0,300,200);
	sceneRTT.add (pointLight);
  
  torus1 = new THREE.Mesh (new THREE.TorusGeometry(10, 0.5, 16, 100),
	new THREE.MeshLambertMaterial({color:0xFF8000}));
  torus1.rotation.x = Math.PI/2;
  torus1.scale.set (10,10,10);
	sceneRTT.add (torus1);
  torus2 = new THREE.Mesh (new THREE.TorusGeometry(10, 0.5, 16, 100),
	new THREE.MeshLambertMaterial({color:0xFF8000}));
  torus2.rotation.y = Math.PI/2;
  torus2.scale.set (10,10,10);
	sceneRTT.add (torus2);
  torus3 = new THREE.Mesh (new THREE.TorusGeometry(10, 0.5, 16, 100),
	new THREE.MeshLambertMaterial({color:0xFF8000}));
  torus3.scale.set (10,10,10);
	sceneRTT.add (torus3);
	
  sceneColor = new THREE.Scene();
  var pointLight1 = new THREE.PointLight (0xffffff);
	pointLight1.position.set (0,300,200);
  sceneColor.add(pointLight1);
  
  var loader = new THREE.ObjectLoader();
  loader.load ('https://youtingkuo.github.io/model/kart.json', 
  function ( obj ) {
  	obj.scale.set (0.064,0.064,0.064);
  	obj.rotation.y = Math.PI;
    obj.position.z = -5;
    obj.position.y = -20;
    sceneColor.add(obj);
  });
  
  sceneMono = new THREE.Scene();
  pointLight = new THREE.PointLight(0xffffff);
  pointLight.position.set(0, 300, 200);
  sceneMono.add(pointLight);
  
  blocker1 = new THREE.Mesh (new THREE.TorusGeometry(10, 0.5, 16, 100),
	new THREE.MeshLambertMaterial({color:0xFF8000, 
  colorWrite:false
  }));
  blocker1.scale.set (10,10,10);
  blocker2 = blocker1.clone();
  blocker3 = blocker2.clone();
  blocker1.rotation.x = Math.PI/2;
  blocker2.rotation.y = Math.PI/2;
  sceneMono.add(blocker1);
  sceneMono.add(blocker2);
  sceneMono.add(blocker3);
  
  scene = new THREE.Scene();
	rttmaterial = new THREE.ShaderMaterial( {
		uniforms: {texture: {type: "t", value: rtTexture},
      fade: {type: "f", value : 2.5}},
		vertexShader: document.getElementById( 'myVertexShader' ).textContent,
		fragmentShader: document.getElementById( 'myFragmentShader' ).textContent} 
		);
  rttmaterial.side = THREE.DoubleSide;
  rttmaterial.depthWrite = false;
  
  var gui = new dat.GUI();
  gui.add(rttmaterial.uniforms.fade, 'value', 0, 5).name('fade');
    
  var plane = new THREE.PlaneGeometry( 300,300 );
	quad = new THREE.Mesh (plane, rttmaterial);
	scene.add (quad);
}

window.onresize = function() {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}

function animate() {
  controls.update();
	
  torus1.rotation.x += angle;
  torus2.rotation.y += angle;
  torus3.rotation.y += angle;
  
  blocker1.rotation.x += angle;
  blocker2.rotation.y += angle;
  blocker3.rotation.y += angle;
  
	requestAnimationFrame ( animate );
	renderer.clear();
  
 	renderer.setClearColor (0x296C20);
	renderer.render (sceneRTT, camera, rtTexture, true);
  
	// render texture to screne
  renderer.setClearColor (0x296C20);
	renderer.render (scene, camera2);
  
  renderer.render(sceneMono, camera);
  renderer.render(sceneColor, camera);
  
}
</script>
</body>

</html>